<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Local and Remote DWN Example</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'IBM Plex Mono';
    }

    input, button {
      font-family: 'IBM Plex Mono'; 
    }

    .box {
      max-width: 52rem;
      display: flex;
      flex-direction: column;
    }

    .box>.row {
      display: flex;
      align-items: start;
      padding-top: 0.5em;
    }

    .box>.row>label {
      padding-right: 0.5em;
      padding-left: 0.5em;
    }

    .box>.row>button {
      margin-left: auto;
      display: block;
    }

    .box>.row>input[type=text] {
      width: 8em;
    }

    .box>.row>textarea {
      width: 250px;
      height: 125px;
    }
    .box .row #write_text_result {
      display: block;
    }
    .green {
      color: green;
    }
    .red {
      color: red;
    }
  </style>
</head>

<body>
  <p style="font-size: large">Write Records</p>

  <div class="box">
    <div class="row">
      <textarea id="write_text_data">...data to save</textarea>
      <button type="button" id="write_text_button">Write Text Data</button>
    </div>
    <div id="write_text_result" class="green"></div>
  </div>


  <script type="module">
    import { Web5 } from 'https://cdn.jsdelivr.net/npm/@tbd54566975/web5@0.3.1-unstable.e2dfe57-2023.3.23-19-07-37/dist/browser.mjs';

    const web5 = new Web5();
    let response;

    let myDid;    
    if (localStorage.getItem('myDid')) {
        myDid = JSON.parse(localStorage.getItem('myDid'));
        console.log("Loading previous did from localStorage");
    } else {
      console.log("Creating new did and storing in local storage");
        myDid = await web5.did.create('ion', {
            services: [{
                'id': 'dwn',
                'type': 'DecentralizedWebNode',
                'serviceEndpoint': {
                    'nodes': ['http://localhost:8085/dwn/',
                              'http://localhost:8086/dwn/',
                              'http://localhost:8087/dwn/',]
                }
            }]
        });        
        localStorage.setItem('myDid', JSON.stringify(myDid));
    }


    console.log('DID:', myDid);

    // Register the DID as one which is running in browser memory and for which keys are available to sign messages.
    web5.did.register({
      connected: true,
      did: myDid.id,
      endpoint: 'app://dwn',
      keys: myDid.keys[0].keypair
    });

    // Write a plain text record to the in-memory DWN.
    response = await web5.dwn.records.write(myDid.id, {
      author: myDid.id,
      data: 'Hello, world!',
      message: {
        schema: 'foo/bar',
        dataFormat: 'text/plain'
      }
    });
    console.log('WRITE RESPONSE:', response.status);

    // Query for the record that was just created.
    response = await web5.dwn.records.query(myDid.id, {
      author: myDid.id,
      message: {
        filter: {
          schema: 'foo/bar'
        }
      }
    });
    console.log('QUERY REPONSE:', response.entries[0]);
    console.log('RESPONSE DATA:', base64UrlToString(response.entries[0].encodedData));

    // Write a JSON record to the in-memory DWN.
    response = await web5.dwn.records.write(myDid.id, {
      author: myDid.id,
      data: { random: 'stuff' },
      message: {
        schema: 'foo/baz',
        dataFormat: 'application/json'
      }
    });
    console.log('WRITE RESPONSE:', response.status);

    // Query for the record that was just created.
    response = await web5.dwn.records.query(myDid.id, {
      author: myDid.id,
      message: {
        filter: {
          schema: 'foo/baz'
        }
      }
    });
    console.log('QUERY REPONSE:', response.entries[0]);
    console.log('RESPONSE DATA:', base64UrlToObject(response.entries[0].encodedData));

    write_text_button.addEventListener('click', async event => {
      const response = await web5.dwn.records.write(myDid.id, {
        author: myDid.id,
        data: write_text_data.value,
        message: {
          schema: 'test/post',
        }
      });
      const responseJSON = await logConsole(response);
      if (responseJSON.status.code === 202) {
        write_text_result.textContent = 'Success';
        write_text_result.classList.add('green');
      } else {
        write_text_result.textContent = 'Failed';
        write_text_result.classList.add('red');
      }
    });


    
    // Long form ION DID with the DWN Service Endpoint:
    //   service: [
    //     {
    //       'id': 'dwn',
    //       'type': 'DecentralizedWebNode',
    //       'serviceEndpoint': {
    //         'nodes': [
    //            'http://localhost:8085/dwn/',
    //            'http://localhost:8086/dwn/',
    //            'http://localhost:8087/dwn/',
    //         ]
    //       }
    //     }
    //   ]
    const bobDid = 'did:ion:EiAa0ZGOuDaAz0IP9dtzfgcr9dqoVLMVjjce3qJVCeAE4g:eyJkZWx0YSI6eyJwYXRjaGVzIjpbeyJhY3Rpb24iOiJyZXBsYWNlIiwiZG9jdW1lbnQiOnsicHVibGljS2V5cyI6W3siaWQiOiJrZXktMSIsInB1YmxpY0tleUp3ayI6eyJjcnYiOiJzZWNwMjU2azEiLCJrdHkiOiJFQyIsIngiOiJPMzhYcDIzR3lNSHBMWTl0SXFFR1dla2MtYU8tYk5pUzQ3VFYtend5ZGMwIiwieSI6Il9OeG0tQ05zWHB3a2NiQ05pT0ZxWnFtUUpDQ2VQbnI3a3JrbklPc1hNd2MifSwicHVycG9zZXMiOlsiYXV0aGVudGljYXRpb24iXSwidHlwZSI6Ikpzb25XZWJLZXkyMDIwIn1dLCJzZXJ2aWNlcyI6W3siaWQiOiJkd24iLCJzZXJ2aWNlRW5kcG9pbnQiOnsibm9kZXMiOlsiaHR0cDovL2xvY2FsaG9zdDo4MDg1L2R3biIsImh0dHA6Ly9sb2NhbGhvc3Q6ODA4Ni9kd24iLCJodHRwOi8vbG9jYWxob3N0OjgwODcvZHduIl19LCJ0eXBlIjoiRGVjZW50cmFsaXplZFdlYk5vZGUifV19fV0sInVwZGF0ZUNvbW1pdG1lbnQiOiJFaURtQ3Utcmo2V2J6QURLcjhoc2FfSnZzd2QwaGdOYzNPVmo0NFkzZzJvUzVnIn0sInN1ZmZpeERhdGEiOnsiZGVsdGFIYXNoIjoiRWlBU3NvZlJ3VGtmOGZNa0RwRTJlZUJiTHZyVkNQT1VXUmdaY3lKQ3laamJSQSIsInJlY292ZXJ5Q29tbWl0bWVudCI6IkVpQ05NVHNrZDRScWZvcmY0QTRwdTZCbmtpUTBPVDA4WWpVM2hSY0VWRjBFOVEifX0';
    
    // Write a JSON record to the remote DWN.
    response = await web5.dwn.records.write(bobDid, {
      author: myDid.id,
      data: { random: 'stuff' },
      message: {
        protocol: 'test',
        schema: 'test/post',
        dataFormat: 'application/json'
      }
    });
    logConsole(response, 'WRITE RESPONSE:');

    // Convenience functions to decode data returned by queries
    function base64UrlToString(encodedData) {
      return web5.dwn.SDK.Encoder.bytesToString(web5.dwn.SDK.Encoder.base64UrlToBytes(encodedData));
    }

    function base64UrlToObject(encodedData) {
      return web5.dwn.SDK.Encoder.base64UrlToObject(encodedData);
    }

    async function logConsole(obj, message = '') {
      let result;
      if (obj instanceof Response) {
        result = await obj.json();
        console.log(message, result);
      } else {
        result = obj;
        console.log(message, result);
      }
      return result;
    }
  </script>
</body>

</html>